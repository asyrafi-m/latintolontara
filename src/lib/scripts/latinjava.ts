const wyanjana:{ [id: string]: string; }  = {
    b: 'ᨅ',       // ba
    ba: 'ᨅ',       // ba
    bi: 'ᨅᨗ',       // bi
    be: 'ᨅᨛ',       // be
    bé: 'ᨅᨙ',       // bé
    bo: 'ᨅᨚ',       // bo
    bu: 'ᨅᨘ',       // bu
    c: 'ᨌ',       // ca
    ca: 'ᨌ',       // ca
    ci: 'ᨌᨗ',       // ca
    ce: 'ᨌᨛ',       // ca
    cee: 'ᨌᨙ',       // ca
    co: 'ᨌᨚ',       // ca
    cu: 'ᨌᨘ',       // ca
    d: 'ᨉ',       // da
    da: 'ᨉ',       // da
    di: 'ᨉᨗ',       // da
    de: 'ᨉᨛ',       // da
    dee: 'ᨉᨙ',       // da
    du: 'ᨉᨚ',       // da
    do: 'ᨉᨘ',       // da
    g: 'ᨁ',       // ga
    ga: 'ᨁ',       // ga
    gi: 'ᨁᨗ',       // ga
    ge: 'ᨁᨛ',       // ga
    go: 'ᨁᨚ',       // ga
    gee: 'ᨁᨙ',       // ga
    gu: 'ᨁᨘ',       // ga
    h: 'ᨖ',       // ha
    ha: 'ᨖ',       // ha
    hi: 'ᨖᨗ',       // ha
    he: 'ᨖᨛ',       // ha
    hee: 'ᨖᨙ',       // ha
    ho: 'ᨖᨚ',       // ha
    hu: 'ᨖᨘ',       // ha
    j: 'ᨍ',       // ja
    ja: 'ᨍ',       // ja
    ji: 'ᨍᨗ',       // ja
    je: 'ᨍᨛ',       // ja
    jee: 'ᨍᨙ',       // ja
    jo: 'ᨍᨚ',       // ja
    ju: 'ᨍᨘ',       // ja
    k: 'ᨀ',       // ka
    ka: 'ᨀ',       // ka
    ki: 'ᨀᨗ',       // ka
    ke: 'ᨀᨛ',       // ka
    kee: 'ᨀᨙ',       // ka
    ko: 'ᨀᨚ',       // ka
    ku: 'ᨀᨘ',       // ka
    l: 'ᨒ',       // la
    la: 'ᨒ',       // la
    li: 'ᨒᨗ',       // la
    le: 'ᨒᨛ',       // la
    lee: 'ᨒᨙ',       // la
    lo: 'ᨒᨚ',       // la
    lu: 'ᨒᨘ',       // la
    m: 'ᨆ',       // ma
    ma: 'ᨆ',       // ma
    mi: 'ᨆᨗ',       // ma
    me: 'ᨆᨛ',       // ma
    mee: 'ᨆᨙ',       // ma
    mo: 'ᨆᨚ',       // ma
    mu: 'ᨆᨘ',       // ma
    mp: 'ᨇ',       // ma
    mpa: 'ᨇ',       // ma
    mpi: 'ᨇᨗ',       // ma
    mpe: 'ᨇᨛ',       // ma
    mpee: 'ᨇᨙ',       // ma
    mpo: 'ᨇᨚ',       // ma
    mpu: 'ᨇᨘ',       // ma
    n: 'ᨊ',       // na
    na: 'ᨊ',       // na
    ni: 'ᨊᨗ',       // na
    ne: 'ᨊᨛ',       // na
    nee: 'ᨊᨙ',       // na
    no: 'ᨊᨚ',       // na
    nu: 'ᨊᨘ',       // na
    ng: 'ᨂ',      // nga
    nga: 'ᨂ',      // nga
    ngi: 'ᨂᨗ',      // nga
    nge: 'ᨂᨛ',      // nga
    ngee: 'ᨂᨙ',      // nga
    ngo: 'ᨂᨚ',      // nga
    ngu: 'ᨂᨘ',      // nga
    ngk: 'ᨃ',      // ngka
    ngka: 'ᨃ',      // ngka
    ngki: 'ᨃᨗ',      // ngka
    ngke: 'ᨃᨛ',      // ngka
    ngkee: 'ᨃᨙ',      // ngka
    ngko: 'ᨃᨚ',      // ngka
    ngku: 'ᨃᨘ',      // ngka
    ny: 'ᨎ',       // nya
    nya: 'ᨎ',       // nya
    nyi: 'ᨎᨗ',       // nya
    nye: 'ᨎᨛ',       // nya
    nyee: 'ᨎᨙ',       // nya
    nyo: 'ᨎᨚ',       // nya
    nyu: 'ᨎᨘ',       // nya
    nc: 'ᨏ',       // nca
    nca: 'ᨏ',       // nca
    nci: 'ᨏᨗ',       // nca
    nce: 'ᨏᨛ',       // nca
    ncee: 'ᨏᨙ',       // nca
    nco: 'ᨏᨚ',       // nca
    ncu: 'ᨏᨘ',       // nca
    nr: 'ᨋ',       // nca
    nra: 'ᨋ',       // nca
    nri: 'ᨋᨗ',       // nca
    nre: 'ᨋᨛ',       // nca
    nree: 'ᨋᨙ',       // nca
    nro: 'ᨋᨚ',       // nca
    nru: 'ᨋᨘ',       // nca
    ñ: 'ᨎ',       // nya
    ña: 'ᨎ',       // nya
    ñi: 'ᨎᨗ',       // nya
    ñe: 'ᨎᨛ',       // nya
    ñee: 'ᨎᨙ',       // nya
    ño: 'ᨎᨚ',       // nya
    ñu: 'ᨎᨘ',       // nya
    p: 'ᨄ',       // pa
    pa: 'ᨄ',       // pa
    pi: 'ᨄᨗ',       // pa
    pe: 'ᨄᨛ',       // pa
    pee: 'ᨄᨙ',       // pa
    po: 'ᨄᨚ',       // pa
    pu: 'ᨄᨘ',       // pa
    r: 'ᨑ',       // ra
    ra: 'ᨑ',       // ra
    ri: 'ᨑᨗ',       // ra
    re: 'ᨑᨛ',       // ra
    ree: 'ᨑᨙ',       // ra
    ro: 'ᨑᨚ',       // ra
    ru: 'ᨑᨘ',       // ra
    s: 'ᨔ',       // sa
    sa: 'ᨔ',       // sa
    si: 'ᨔᨗ',       // sa
    se: 'ᨔᨛ',       // sa
    see: 'ᨔᨙ',       // sa
    so: 'ᨔᨚ',       // sa
    su: 'ᨔᨘ',       // sa
    t: 'ᨈ',       // ta
    ta: 'ᨈ',       // ta
    ti: 'ᨈᨗ',       // ta
    te: 'ᨈᨛ',       // ta
    tee: 'ᨈᨙ',       // ta
    to: 'ᨈᨚ',       // ta
    tu: 'ᨈᨘ',       // ta
    w: 'ᨓ',       // wa
    wa: 'ᨓ',       // wa
    wi: 'ᨓᨗ',       // wa
    we: 'ᨓᨛ',       // wa
    wee: 'ᨓᨙ',       // wa
    wo: 'ᨓᨚ',       // wa
    wu: 'ᨓᨘ',       // wa
    y: 'ᨐ',       // ya
    ya: 'ᨐ',       // ya
    yi: 'ᨐᨗ',       // ya
    ye: 'ᨐᨛ',       // ya
    yee: 'ᨐᨙ',       // ya
    yo: 'ᨐᨚ',       // ya
    yu: 'ᨐᨘ',       // ya
    a: 'ᨕ',
    i: 'ᨕᨗ',
    e: 'ᨕᨛ',
    ee: 'ᨕᨙ',
    o: 'ᨕᨚ',
    u: 'ᨕᨘ',
}

const sandhanganSwara:{ [id: string]: string; } = { 
    // a: '',
    // i: '◌ᨗ', // tetti’ riase’	
    // e: '◌ᨛ', // kecce’ riase’
    // é: ' ᨙ', // kecce’ riolo	
    // o: '◌ᨚ', // kecce’ rimunri	
    // u: '◌ᨘ', // tetti’ riawa	

}

const swara:{ [id: string]: string; }  = {
    // A: 'ꦄ',       // aksara swara a
    // I: 'ꦆ',       // aksara swara i
    // U: 'ꦈ',       // aksara swara u
    // E: 'ꦌ',       // aksara swara e
    // È: 'ꦌ',       // aksara swara e
    // É: 'ꦌ',       // aksara swara e
    // Ê: 'ꦄꦼ',      // aksara swara ê
    // Ě: 'ꦄꦼ',      // aksara swara ê
    // O: 'ꦎ',       // aksara swara o
}

const murdaConsonants:{ [id: string]: string; } = {
    //  'n': 'ꦟ',      // na murda
    //  'k': 'ꦑ',       // ka murda
    //  'kh': 'ꦑ꦳',       // kha murda
    //  't': 'ꦡ',       // ta murda
    //  's': 'ꦯ',      // sa murda
    //  'p': 'ꦦ',       // pa murda
    //  'f': 'ꦦ꦳',       // fa murda
    //  'ny': 'ꦘ',      // nya murda
    //  'ñ': 'ꦘ',       // nya murda
    //  'g': 'ꦓ',      // ga murda
    //  'gh': 'ꦓ꦳',      // gha murda
    //  'b': 'ꦨ',       // ba murda
}

const sandhanganWyanjana:{ [id: string]: string; } = {
    //  r: 'ꦿ',   // cakra
    //  ṛ: 'ꦽ',   // cakra keret
    //  y: 'ꦾ',   // pengkal
}

const sandhanganPanyigeg:{ [id: string]: string; } = {
    //  r: 'ꦂ',
    //  h: 'ꦃ', 
    //  ng: 'ꦁ',
}

const pada:{ [id: string]: string; } = {
    //  ' ' : '​',
    //  '.' : '꧉',
    //  ',' : '꧈',
    //  '-' : '',
}

function convert(str:string, isIgnoreSpace:boolean = false, isMurda:boolean = false, isDiphthong:boolean = false):string {
    var length = str.length;
    var output = [];
    var isMurdaAlreadyIncluded = false;
    var isAlreadyStacked = false;

    for (var i = 0; i < length; i++)
    {
        var c:string = str[i];

        if(i + 1 < length) {
            var cc:string = c + str[i + 1];
            
            if(isConsonants(cc) || isConsonants(cc.toLowerCase())) {
                i++;
                
                if(cc === cc.toUpperCase()) {
                    cc = cc.toLowerCase();
                }

                if(isConsonantsSandhanganPanyigeg(cc)) {
                    isAlreadyStacked = false;
                    
                    if(i - 2 >= 0 && i + 1 < length) {
                        var cBefore = str[i - 2];
                        var cAfter = str[i + 1];

                        if(isVowels(cBefore) && !isVowels(cAfter)) {
                            output.push(sandhanganPanyigeg[cc]);
                            continue;
                        }
                    }

                    if(i - 2 >= 0 && i === length - 1) {
                        var cBefore = str[i - 2];

                        if(isVowels(cBefore)) {
                            output.push(sandhanganPanyigeg[cc]);
                            continue;
                        }
                    }
                }

                // prevent "tumpuk telu" by adding zero width space
                if(output.length - 2 >= 0) {
                    var lastOutput:string = output[output.length - 1];
                    var lastOutput2:string = output[output.length - 2];
                    
                    if(isPangkon(lastOutput) && isWyanjanaPasanganInBelow(lastOutput2)) { 
                        if(isAlreadyStacked) {
                            // pop last two output
                            output.pop();
                            output.pop();

                            output.push(); // push zero width space

                            // push again last two output
                            output.push(lastOutput2);
                            output.push(lastOutput);
                            isAlreadyStacked = false;
                        } else {
                            isAlreadyStacked = true;
                        }
                    }
                }

                if(isMurda && !isMurdaAlreadyIncluded && isConsonantsMurda(cc)) {
                    output.push(murdaConsonants[cc]);
                    isMurdaAlreadyIncluded = true;
                } else {
                    output.push(wyanjana[cc]);
                }
                
                output.push(''); //꧀
                continue;
            }
        }

        if(isConsonantsSandhanganPanyigeg(c)) {
            isAlreadyStacked = false;
            let isSandhanganPanyigeg = false;

            if(i - 1 >= 0 && i + 1 < length) {
                var cBefore = str[i - 1];
                var cAfter = str[i + 1];

                if(isVowels(cBefore) && !isVowels(cAfter)) {
                    isSandhanganPanyigeg = true;
                }
            }

            if(i - 1 >= 0 && i === length - 1) {
                var cBefore = str[i - 1];

                if(isVowels(cBefore)) {
                    isSandhanganPanyigeg = true;
                }
            }

            if(isSandhanganPanyigeg) {
                // remove pangkon if exist
                if(output.length - 1 >= 0) {
                    var lastOutput:string = output[output.length - 1];   

                    if(isPangkon(lastOutput)) {
                        output.pop();
                    }
                }

                output.push(sandhanganPanyigeg[c]);
                continue;
            }
        }
        
        if(isConsonantsSandhanganWyanjana(c)) {
            isAlreadyStacked = false;
            let isSandhanganWyanjana = false;

            if(i - 2 >= 0) {
                var cBefore = str[i - 2] + str[i - 1];

                if(isConsonants(cBefore) && !isSandhanganPanyigeg(output[output.length - 1])) {
                    isSandhanganWyanjana = true;
                }
            }

            if(i - 1 >= 0) {
                var cBefore = str[i - 1];

                if(isConsonants(cBefore) && !isSandhanganPanyigeg(output[output.length - 1])) {
                    isSandhanganWyanjana = true;
                }
            }

            if(isSandhanganWyanjana) {
                // remove pangkon if exist
                if(output.length - 1 >= 0) {
                    var lastOutput:string = output[output.length - 1];   

                    if(isPangkon(lastOutput)) {
                        output.pop();
                    }
                }

                output.push(sandhanganWyanjana[c]);
                continue;
            }
        }
        
        if(isConsonants(c) || isConsonants(c.toLowerCase())) {
            if(c === c.toUpperCase()) {
                c = c.toLowerCase();
            }

            // prevent "tumpuk telu" by adding zero width space
            if(output.length - 2 >= 0) {
                var lastOutput:string = output[output.length - 1];
                var lastOutput2:string = output[output.length - 2];
                
                if(isPangkon(lastOutput) && isWyanjanaPasanganInBelow(lastOutput2)) { 
                    if(isAlreadyStacked) {
                        output.pop();
                        output.pop();

                        output.push('​'); // push zero width space
                        output.push(lastOutput2);
                        output.push(lastOutput);
                        isAlreadyStacked = false;
                    } else {
                        isAlreadyStacked = true;
                    }
                }
            }

            if(isMurda && !isMurdaAlreadyIncluded && isConsonantsMurda(c)) {
                output.push(murdaConsonants[c]);
                isMurdaAlreadyIncluded = true;
            } else {
                output.push(wyanjana[c]);
            }

            output.push(''); //꧀
            continue;
        }

        if(isVowelsSwara(c)) {
            isAlreadyStacked = false;

            output.push(swara[c]);
            continue;
        }
        
        if(isVowels(c)) {
            isAlreadyStacked = false;

            if(i + 1 < length) {
                var c2 = str[i + 1];

                // change ia, iu, ie, iê, io to iya, iyu, iye, iyê, iyo
                if(isVowelsWulu(c) && isVowels(c2) && !isVowelsWulu(c2)) {
                    str = str.substring(0, i + 1) + 'y' + str.substring(i + 1, str.length);
                    length = str.length;
                }

                // change ua, ui, ue, uê, uo to uwa, uwi, uwe, uwê, uwo
                if(isVowelsSuku(c) && isVowels(c2) && !isVowelsSuku(c2)) {
                    str = str.substring(0, i + 1) + 'w' + str.substring(i + 1, str.length);
                    length = str.length;
                }

                // change ea to eya
                if(isVowelsTaling(c) && isVowelsA(c2)) {
                    str = str.substring(0, i + 1) + 'y' + str.substring(i + 1, str.length);
                    length = str.length;
                }

                // change eo to eyo
                if(isVowelsTaling(c) && isVowelsTalingTarung(c2)) {
                    str = str.substring(0, i + 1) + 'y' + str.substring(i + 1, str.length);
                    length = str.length;
                }
                
                // change oa to owa
                if(isVowelsTalingTarung(c) && isVowelsA(c2)) {
                    str = str.substring(0, i + 1) + 'w' + str.substring(i + 1, str.length);
                    length = str.length;
                }
                
                // change oe to owe
                if(isVowelsTalingTarung(c) && isVowelsTaling(c2)) {
                    str = str.substring(0, i + 1) + 'w' + str.substring(i + 1, str.length);
                    length = str.length;
                }
            }
            
            if(isVowelsPepet(c)) {
                // check cakra keret
                if(output.length - 1 >= 0) {
                    var lastOutputChar = output[output.length - 1];
                    
                    if(isCakra(lastOutputChar)) {
                        output.pop();
                        output.push('ꦽ');
                        continue;
                    }

                     // check nga lelet
                    if(i - 1 >= 0) {
                        var cBefore = str[i - 1];
                        
                        if(cBefore === 'l' && !isPangkon(lastOutputChar)) {
                            output.pop(); // pop pangkon
                            output.pop(); // pop aksara la
                            output.push('ꦊ');
                            continue;
                        }
                    }
                }

                if(i - 1 >= 0) {
                    var cBefore = str[i - 1];
                    
                    // check pa ceret
                    if(cBefore === 'r') {
                        output.pop(); // pop pangkon
                        output.pop(); // pop aksara ra
                        output.push('ꦉ');
                        continue;
                    }
                }
            }            
            
            if(i - 1 >= 0 && isConsonants(str[i - 1])) {
                // check pangkon
                if(output.length - 1 >= 0) {
                    var lastOutputChar = output[output.length - 1];
                    
                    if(isPangkon(lastOutputChar)) {
                        output.pop();
                    }
                }

                output.push(sandhanganSwara[c]);
            } else {
                output.push(wyanjana['h']);
                output.push(sandhanganSwara[c]);
            }

            // isDiphthong
            if(isDiphthong && i + 1 < length && isVowels(str[i + 1])) {
                var c2 = str[i + 1];

                if(isVowelsA(c) && isVowelsA(c2)) {
                    output.push(sandhanganSwara['aa']);
                    i++;
                    continue;
                }

                if(isVowelsA(c) && isVowelsWulu(c2)) {
                    output.push(sandhanganSwara['ai']);
                    i++;
                    continue;
                }

                if(isVowelsA(c) && isVowelsSuku(c2)) {
                    output.push(sandhanganSwara['au']);
                    i++;
                    continue;
                }

                if(isVowelsWulu(c) && isVowelsWulu(c2)) {
                    output.pop();
                    output.push(sandhanganSwara['ii']);
                    i++;
                    continue;
                }
                
                if (isVowelsSuku(c) && isVowelsSuku(c2)) {
                    output.pop();
                    output.push(sandhanganSwara['uu']);
                    i++;
                    continue;
                }
            }

            continue;
        }
        
        if(isCharactersPada(c)) {
            isAlreadyStacked = false;

            if(isIgnoreSpace && c === ' ') {
                continue;
            }

            output.push(pada[c]);
            continue;
        }
        
        output.push(c);
    }

    return output.join('');
}

function isWyanjana(key:string) { return Object.values(wyanjana).includes(key); }

function isWyanjanaPasanganInRight(wyanjana:string):boolean { 
    return wyanjana === 'ꦥ' || wyanjana === 'ꦥ꦳' || wyanjana === 'ꦲ' || wyanjana === 'ꦏ꧀ꦱ' || wyanjana === 'ꦰ' || wyanjana === 'ꦱ' || wyanjana === 'ꦦ'; 
}

function isWyanjanaPasanganInBelow(wyanjana:string):boolean { 
    return isWyanjana(wyanjana) && !isWyanjanaPasanganInRight(wyanjana); 
}

function isSandhanganWyanjana(key:string):boolean { return Object.values(sandhanganWyanjana).includes(key); }

function isSandhanganPanyigeg(key:string):boolean { return Object.values(sandhanganPanyigeg).includes(key); }

function isConsonants(s:string):boolean { 
    return Object.prototype.hasOwnProperty.call(wyanjana, s.toLowerCase()); 
}

function isConsonantsMurda(s:string):boolean {
    return Object.prototype.hasOwnProperty.call(murdaConsonants, s.toLowerCase()); 
}

function isConsonantsSandhanganPanyigeg(s:string):boolean {
    return Object.prototype.hasOwnProperty.call(sandhanganPanyigeg, s.toLowerCase());
}

function isConsonantsSandhanganWyanjana(s:string):boolean {
    return Object.prototype.hasOwnProperty.call(sandhanganWyanjana, s.toLowerCase());
}

function isVowels(s:string):boolean { 
    return Object.prototype.hasOwnProperty.call(sandhanganSwara, s); 
}

function isVowelsSwara(s:string):boolean { 
    return Object.prototype.hasOwnProperty.call(swara, s); 
}

function isCharactersPada(s:string):boolean {
    return Object.prototype.hasOwnProperty.call(pada, s);
}

function isVowelsA(s:string):boolean {
    return s === 'a' || s === 'ô';
}

function isVowelsPepet(s:string):boolean {
    return s === 'ê' || s === 'ě';
}

function isVowelsWulu(s:string):boolean {
    return s === 'i';
}

function isVowelsSuku(s:string):boolean {
    return s === 'u';
}

function isVowelsTaling(s:string):boolean {
    return s === 'e' || s === 'é' || s === 'è';
}

function isVowelsTalingTarung(s:string):boolean {
    return s === 'o';
}

function isPangkon(s:string):boolean {
    return s === ''; // ꧀
}

function isCakra(s:string):boolean {
    return s === 'ꦿ';
}

export { convert };